<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simula√ß√£o ATS - Grupo 5</title>
  <style>
    /* (mantive seu CSS exatamente como estava; omiti coment√°rios para brevidade) */
    body{background:#050505;color:#e0e0e0;font-family:'Courier New',monospace;margin:0;height:100vh;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .background-fixed{position:fixed;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;z-index:-5;transition:all 1s}
    .bg-prologue{filter:brightness(.4) contrast(1.1)}
    .bg-game{background-image:url('img1.jpg');filter:brightness(.3) contrast(1.2) blur(2px)}
    #disaster-layer{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-4;display:none}
    #lightning-flash{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,.9);z-index:-3;opacity:0;pointer-events:none}
    .rain{position:absolute;background:linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,.6));width:2px;height:60px;top:-60px;border-radius:2px;pointer-events:none}
    .fire-particle{position:absolute;background:radial-gradient(circle, rgba(255,80,0,.8) 0%, rgba(255,0,0,0) 70%);border-radius:50%;bottom:-50px;pointer-events:none;filter:blur(4px);mix-blend-mode:screen}
    .shake-screen{animation:shake .5s cubic-bezier(.36,.07,.19,.97) both}
    @keyframes rain-fall{to{transform:translateY(120vh)}}
    @keyframes rise{0%{transform:translateY(0) scale(1);opacity:.8}100%{transform:translateY(-80vh) scale(0);opacity:0}}
    @keyframes shake{10%,90%{transform:translate3d(-2px,0,0)}20%,80%{transform:translate3d(2px,0,0)}30%,50%,70%{transform:translate3d(-4px,0,0)}40%,60%{transform:translate3d(4px,0,0)}}
    @keyframes flash-anim{0%{opacity:0}10%{opacity:.9}20%{opacity:0}100%{opacity:0}}
    #prologue-container{width:90%;max-width:900px;background-color:rgba(20,20,25,.95);border:1px solid #444;border-top:5px solid #2196F3;border-radius:8px;padding:40px;box-shadow:0 0 50px rgba(0,0,0,.9);display:flex;flex-direction:column;align-items:center;text-align:center;z-index:1000;animation:fadeIn 1s;position:relative}
    #prologue-title{color:#2196F3;font-size:1.5em;text-transform:uppercase;letter-spacing:2px;margin-bottom:20px;border-bottom:1px solid #333;padding-bottom:10px;width:100%}
    #prologue-text{font-size:1.3em;line-height:1.6;min-height:200px;white-space:pre-wrap;margin-bottom:30px;text-align:left;color:#fff}
    .nav-buttons{display:flex;gap:20px;width:100%;justify-content:space-between;align-items:center}
    .btn-prologue{background:transparent;border:1px solid #2196F3;color:#2196F3;padding:10px 30px;font-size:1em;cursor:pointer;transition:all .3s;font-family:inherit}
    .btn-prologue:hover{background:#2196F3;color:#fff}
    #intro-screen{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.9);z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;opacity:0}
    #intro-content h1{color:#ff3d00;font-size:4em;margin-bottom:0;text-transform:uppercase;text-shadow:0 0 20px rgba(255,61,0,.8);animation:pulse 1.5s infinite;letter-spacing:5px}
    #intro-content h2{color:#fff;font-weight:normal;margin-top:10px;font-size:1.5em}
    #btn-start-simulation{background:transparent;border:3px solid #ff3d00;color:#ff3d00;padding:20px 50px;font-size:1.8em;font-family:inherit;font-weight:700;cursor:pointer;margin-top:50px;transition:all .3s;text-transform:uppercase;animation:borderPulse 2s infinite}
    #btn-start-simulation:hover{background:#ff3d00;color:#000;box-shadow:0 0 30px #ff3d00}
    #game-container{width:80%;max-width:800px;background-color:rgba(20,20,20,.95);border:1px solid #444;border-left:5px solid #d32f2f;border-radius:8px;padding:40px;box-shadow:0 0 30px rgba(0,0,0,.8);min-height:400px;display:none;flex-direction:column;opacity:0;z-index:500;position:relative}
    .header{border-bottom:1px solid #555;padding-bottom:10px;margin-bottom:20px;display:flex;justify-content:space-between;font-size:.9em;color:#888}
    .status-blink{color:#d32f2f;font-weight:700;animation:blink 1s infinite}
    #story-text{font-size:1.2em;line-height:1.6;white-space:pre-wrap;min-height:100px}
    #feedback-area{margin-bottom:20px;font-weight:700;padding:15px;border-radius:4px;display:none;font-size:1.1em}
    .feedback-success{background-color:rgba(46,125,50,.2);border:1px solid #2e7d32;color:#81c784}
    .feedback-error{background-color:rgba(198,40,40,.2);border:1px solid #c62828;color:#e57373}
    .choices{display:flex;flex-direction:column;gap:10px;margin-top:30px;opacity:0;transition:opacity 1s}
    .btn{background:transparent;border:1px dashed #FFEB3B;color:#FFEB3B;padding:15px;text-align:left;font-family:inherit;font-size:1.1em;cursor:pointer;transition:all .2s}
    .btn:hover{background:#FFEB3B;color:#000;border-style:solid;transform:translateX(5px)}
    .cursor{display:inline-block;width:10px;height:1em;background-color:#0f0;animation:blink 1s infinite;vertical-align:bottom}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
    @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:.8}100%{transform:scale(1);opacity:1}}
    @keyframes borderPulse{0%{box-shadow:0 0 0 0 rgba(255,61,0,.7)}70%{box-shadow:0 0 0 15px rgba(255,61,0,0)}100%{box-shadow:0 0 0 0 rgba(255,61,0,0)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  </style>
</head>
<body>
  <div class="background-fixed bg-prologue" id="main-bg"></div>
  <div id="disaster-layer"></div>
  <div id="lightning-flash"></div>

  <audio id="audio-prologue" src="" preload="auto"></audio>
  <audio id="audio-news" src="noticia.mp3" preload="auto"></audio>
  <audio id="audio-game" src="audio.mp3" preload="auto"></audio>

  <div id="prologue-container">
    <div id="prologue-title">INTRODU√á√ÉO T√âCNICA</div>
    <div id="prologue-text"></div>
    <div class="nav-buttons">
      <button class="btn-prologue" id="btn-prev-prologue" style="visibility:hidden">Anterior</button>
      <button class="btn-prologue" id="btn-play-pause" style="min-width:160px">‚ñ∂Ô∏è Play</button>
      <button class="btn-prologue" id="btn-next-prologue">Pr√≥ximo ‚ûú</button>
    </div>
  </div>

  <div id="intro-screen">
    <div id="intro-content">
      <h1>ATEN√á√ÉO</h1>
      <h2>SITUA√á√ÉO DE DESASTRE EM ANDAMENTO</h2>
      <h2>A√á√ÉO IMEDIATA NECESS√ÅRIA</h2>
      <button id="btn-start-simulation">INICIAR OPERA√á√ÉO</button>
    </div>
  </div>

  <div id="game-container">
    <div class="header">
      <span>SALA DE SITUA√á√ÉO: GRUPO 5</span>
      <span class="status-blink">‚óè AO VIVO - PETR√ìPOLIS</span>
    </div>
    <div id="feedback-area"></div>
    <div id="text-container"><span id="story-text"></span><span class="cursor"></span></div>
    <div id="choices-container" class="choices"></div>
  </div>

  <script>
    // refer√™ncias
    const prologueContainer = document.getElementById('prologue-container');
    const introScreen = document.getElementById('intro-screen');
    const gameContainer = document.getElementById('game-container');
    const mainBg = document.getElementById('main-bg');
    const disasterLayer = document.getElementById('disaster-layer');
    const lightningFlash = document.getElementById('lightning-flash');

    const audioPrologue = document.getElementById('audio-prologue');
    const audioNews = document.getElementById('audio-news');
    const audioGame = document.getElementById('audio-game');
    const btnPlayPause = document.getElementById('btn-play-pause');
    const btnNext = document.getElementById('btn-next-prologue');
    const btnPrev = document.getElementById('btn-prev-prologue');
    const btnStartSim = document.getElementById('btn-start-simulation');

    // garantir que o √°udio do jogo toque apenas 1 vez
    audioGame.loop = false;
    audioGame.volume = 0.6;
    let audioGameStarted = false; // FLAG segura

    // prote√ß√£o extra caso play seja chamado acidentalmente
    audioGame.addEventListener('play', () => {
      audioGame.loop = false;
      audioGameStarted = true;
      console.debug('audioGame: play event - audioGameStarted set true');
    });

    audioGame.addEventListener('ended', () => {
      console.debug('audioGame: ended');
      // comportamento ao terminar: por padr√£o paramos os efeitos de desastre
      stopDisasterEffect();
    });

    // efeitos visuais
    let disasterInterval;
    let lightningInterval;
    function triggerLightning(){
      lightningFlash.style.animation = 'none';
      void lightningFlash.offsetHeight;
      lightningFlash.style.animation = 'flash-anim .35s ease-out';
      if (gameContainer.style.display === 'flex') {
        gameContainer.classList.remove('shake-screen');
        void gameContainer.offsetWidth;
        gameContainer.classList.add('shake-screen');
      }
    }
    function startDisasterEffect(type){
      clearInterval(disasterInterval);
      clearInterval(lightningInterval);
      disasterLayer.innerHTML = '';
      disasterLayer.style.display = 'block';
      if (type === 'rain' || type === 'storm'){
        disasterInterval = setInterval(() => {
          for (let i=0;i<4;i++){
            const d = document.createElement('div');
            d.className='rain';
            d.style.left = Math.random()*100 + 'vw';
            d.style.height = (Math.random()*20 + 30) + 'px';
            d.style.animation = `rain-fall ${Math.random()*0.6 + 0.8}s linear`;
            disasterLayer.appendChild(d);
            setTimeout(()=>{ try{ d.remove() }catch(e){} }, 1200);
          }
        },120);
        if (type === 'storm'){
          lightningInterval = setInterval(()=>{ if(Math.random()>0.5) triggerLightning(); }, 2500);
        }
      } else if (type === 'fire'){
        disasterInterval = setInterval(()=>{
          for(let i=0;i<3;i++){
            const ember = document.createElement('div');
            ember.className='fire-particle';
            ember.style.left = Math.random()*100 + 'vw';
            ember.style.width = (Math.random()*20 + 5) + 'px';
            ember.style.height = ember.style.width;
            const color = Math.random()>0.5 ? 'rgba(255,80,0,.8)' : 'rgba(255,200,0,.6)';
            ember.style.background = `radial-gradient(circle, ${color} 0%, rgba(255,0,0,0) 70%)`;
            ember.style.animation = `rise ${Math.random()*1.5 + 1}s ease-out forwards`;
            disasterLayer.appendChild(ember);
            setTimeout(()=>{ try{ ember.remove() }catch(e){} }, 2500);
          }
        },120);
      }
    }
    function stopDisasterEffect(){
      clearInterval(disasterInterval);
      clearInterval(lightningInterval);
      disasterLayer.innerHTML = '';
      disasterLayer.style.display = 'none';
    }

    // prologue data (mantido)
    let currentPrologueIndex = 0;
    let isFirstInteraction = true;
    const prologueData = [
      { title:"IN√çCIO", text:"\"Quando um desastre acontece ‚Äî ...\"", img:"https://www.pragmatismopolitico.com.br/wp-content/uploads/2018/05/acidente-cuba-e1527030296940.jpg", audio:"audio1.mp3", effectType:'rain' },
      { title:"O PAPEL DO M√âDICO", text:"\"Um desastre √© qualquer evento ...\"", img:"https://images.unsplash.com/photo-1584036561566-baf8f5f1b144?auto=format&fit=crop&w=1920&q=80", audio:"audio2.mp3" },
      { title:"TRIAGEM (M√âTODO START)", text:"\"A triagem √© o cora√ß√£o ...\"", img:"https://images.unsplash.com/photo-1516574187841-69301976e49e?auto=format&fit=crop&w=1920&q=80", audio:"audio3.mp3" },
      { title:"SITUA√á√ïES SIMPLES", text:"\"Mesmo nos desastres, ...\"", img:"https://www.saude.sp.gov.br/resources/hospital-leonor-mendes-de-barros/acesso-rapido/primeiros-socorros-em-caso-de-incendio.jpg", audio:"audio4.mp3" },
      { title:"ALTA COMPLEXIDADE", text:"\"Em outros cen√°rios, ...\"", img:"https://ogimg.infoglobo.com.br/in/23946251-8e9-d10/FT1086A/GettyImages-56441651.jpg", audio:"audio5.mp3", effectType:'fire' },
      { title:"LOG√çSTICA E LIDERAN√áA", text:"\"O m√©dico tamb√©m coordena ...\"", img:"https://cdn.folhape.com.br/img/c/1200/900/dn_arquivo/2020/01/medico1.jpg", audio:"audio6.mp3" },
      { title:"A ESS√äNCIA", text:"\"No fim, atuar em um desastre ...\"", img:"https://blog.unyleyamed.com.br/wp-content/uploads/2023/09/shutterstock_661890763-scaled.webp", audio:"audio7.mp3" }
    ];

    function manageAudioState(audioFile, shouldPlay=true){
      if (!audioPrologue.paused) audioPrologue.pause();
      if (audioPrologue.getAttribute('src') !== audioFile){
        audioPrologue.src = audioFile;
        audioPrologue.load();
      }
      if (shouldPlay && !isFirstInteraction){
        audioPrologue.play().then(()=>{ btnPlayPause.innerText = "‚è∏Ô∏è Pausar Narra√ß√£o"; }).catch(e=>{ console.log("Autoplay blocked"); btnPlayPause.innerText = "‚ñ∂Ô∏è Tocar Narra√ß√£o"; });
      } else {
        btnPlayPause.innerText = "‚ñ∂Ô∏è Tocar Narra√ß√£o";
      }
    }

    function updatePrologue(){
      const data = prologueData[currentPrologueIndex];
      document.getElementById('prologue-title').innerText = data.title;
      document.getElementById('prologue-text').innerText = data.text;
      mainBg.style.backgroundImage = `url('${data.img}')`;
      if (data.effectType) startDisasterEffect(data.effectType); else stopDisasterEffect();
      btnPrev.style.visibility = currentPrologueIndex === 0 ? 'hidden' : 'visible';
      if (currentPrologueIndex === prologueData.length - 1){
        btnNext.innerText = "IR PARA A√á√ÉO ‚ö†"; btnNext.style.borderColor = "#ff3d00"; btnNext.style.color = "#ff3d00";
      } else {
        btnNext.innerText = "Pr√≥ximo ‚ûú"; btnNext.style.borderColor="#2196F3"; btnNext.style.color="#2196F3";
      }
      if (data.audio){
        const shouldPlay = !isFirstInteraction && currentPrologueIndex > 0;
        manageAudioState(data.audio, shouldPlay);
      }
    }

    // eventos
    btnNext.addEventListener('click', ()=>{
      if (isFirstInteraction) isFirstInteraction = false;
      if (currentPrologueIndex < prologueData.length - 1){
        currentPrologueIndex++;
        updatePrologue();
      } else {
        // FIM DO PR√ìLOGO -> A√á√ÉO IMEDIATA (IR PARA A√á√ÉO)
        stopDisasterEffect();
        audioPrologue.pause();

        // Inicia o √°udio do jogo apenas se ainda n√£o iniciou (FLAG)
        if (!audioGameStarted){
          audioGame.currentTime = 0;
          audioGame.play().catch(e=>console.warn("Erro ao tocar audioGame:", e));
          // audioGameStarted ficar√° true no evento 'play' do audioGame
        } else {
          console.debug('audioGame j√° iniciado anteriormente; n√£o reiniciando');
        }

        // Ativa tempestade em plano de fundo
        startDisasterEffect('storm');

        // mostra alerta
        showIntroScreen();
      }
    });

    btnPrev.addEventListener('click', ()=>{
      if (currentPrologueIndex > 0){ currentPrologueIndex--; updatePrologue(); }
    });

    btnPlayPause.addEventListener('click', ()=>{
      if (isFirstInteraction){ isFirstInteraction = false; manageAudioState(prologueData[currentPrologueIndex].audio, true); return; }
      if (audioPrologue.paused){ audioPrologue.play(); btnPlayPause.innerText = "‚è∏Ô∏è Pausar Narra√ß√£o"; }
      else { audioPrologue.pause(); btnPlayPause.innerText = "‚ñ∂Ô∏è Tocar Narra√ß√£o"; }
    });

    function showIntroScreen(){
      prologueContainer.style.display = 'none';
      mainBg.style.backgroundImage = "url('img1.jpg')";
      mainBg.className = "background-fixed bg-game";
      introScreen.style.display = 'flex';
      setTimeout(()=>{ introScreen.style.opacity = '1' }, 50);
    }

    // btnStartSim: N√ÉO FOR√áAR play() novamente ‚Äî apenas garante que, se por algum motivo ainda n√£o iniciou, inicie
    btnStartSim.addEventListener('click', ()=>{
      audioNews.pause();
      if (!audioGameStarted){
        // ainda n√£o foi iniciado ‚Äî inicia uma √∫nica vez
        audioGame.currentTime = 0;
        audioGame.play().catch(e=>console.error("Erro game audio:", e));
      } else {
        console.debug('btnStartSim: audioGame j√° iniciado anteriormente; n√£o chamar play()');
      }
      // reinicia/assegura efeitos
      startDisasterEffect('storm');

      introScreen.style.transition = "opacity 1s";
      introScreen.style.opacity = '0';
      setTimeout(()=>{
        introScreen.style.display = 'none';
        gameContainer.style.display = 'flex';
        setTimeout(()=>{ gameContainer.style.opacity='1'; gameContainer.style.animation='fadeIn 1s ease-out'; goTo('start') }, 100);
      }, 1000);
    });

    // motor do jogo (mantido resumido)
    const story = {
      "start": { text: "[06:05] CONEX√ÉO ESTABELECIDA...", choices:[{text:"A - Ir pessoalmente",target:"erro_gestao"},{text:"B - Focar na Gest√£o",target:"fase_2"}] },
      "erro_gestao": { text:"Voc√™ chega √† Zona de Impacto...", feedback:{type:"error",msg:"ERRO DE GEST√ÉO..."}, choices:[{text:"Reiniciar Simula√ß√£o",target:"start"}] },
      "fase_2": { text:"Decis√£o correta...", feedback:{type:"success",msg:"ACERTO..."}, choices:[{text:"A - 100%",target:"erro_prevencao"},{text:"B - 70%/30%",target:"fase_3"}] },
      "erro_prevencao": { text:"12 horas se passam...", feedback:{type:"error",msg:"FALHA NA PREVEN√á√ÉO"}, choices:[{text:"Tentar Novamente",target:"retry_fase_2"},{text:"Reiniciar do Zero",target:"start"}] },
      "fase_3": { text:"[10:00] A equipe retorna...", feedback:{type:"success",msg:"ACERTO..."}, choices:[{text:"A - Leptospirose",target:"erro_clinico"},{text:"B - Surto Respirat√≥rio",target:"erro_clinico"},{text:"C - Causa Raiz",target:"fase_4"}] },
      "erro_clinico": { text:"Voc√™ envia insumos m√©dicos...", feedback:{type:"error",msg:"ERRO DE VIS√ÉO"}, choices:[{text:"Tentar Novamente",target:"retry_fase_3"},{text:"Reiniciar do Zero",target:"start"}] },
      "fase_4": { text:"[11:00] Voc√™ tenta contatar a Defesa Civil...", feedback:{type:"success",msg:"ACERTO..."}, choices:[{text:"A - Continuar pelos canais",target:"erro_burocracia"},{text:"B - Ir fisicamente",target:"vitoria"}] },
      "erro_burocracia": { text:"Voc√™ perde 3 horas...", feedback:{type:"error",msg:"FALHA DE ARTICULA√á√ÉO"}, choices:[{text:"Tentar Novamente",target:"retry_fase_4"},{text:"Reiniciar do Zero",target:"start"}] },
      "vitoria": { text:"[11:30] Voc√™ vai pessoalmente...", feedback:{type:"success",msg:"MISS√ÉO CUMPRIDA"}, choices:[{text:"Reiniciar Apresenta√ß√£o",target:"start"}] }
    };

    const textElement = document.getElementById('story-text');
    const choicesContainer = document.getElementById('choices-container');
    const feedbackArea = document.getElementById('feedback-area');

    function typeWriter(text,i,cb){
      if (i < text.length){
        textElement.innerHTML = text.substring(0,i+1) + '<span class="cursor"></span>';
        setTimeout(()=>typeWriter(text,i+1,cb),15);
      } else { if (cb) cb(); }
    }

    function goTo(sceneId){
      const scene = story[sceneId];
      textElement.innerHTML = '';
      choicesContainer.innerHTML = '';
      choicesContainer.style.opacity = '0';
      feedbackArea.style.display = 'none';
      if (scene.feedback){
        feedbackArea.style.display = 'block';
        feedbackArea.className = scene.feedback.type === 'success' ? 'feedback-success' : 'feedback-error';
        const icon = scene.feedback.type === 'success' ? 'üë®‚Äç‚öïÔ∏èüëç' : 'üë®‚Äç‚öïÔ∏èüëé';
        feedbackArea.innerText = icon + " " + scene.feedback.msg;
      }
      typeWriter(scene.text,0,()=>renderButtons(scene.choices));
    }

    function renderButtons(choices){
      choices.forEach(c=>{
        const btn = document.createElement('button');
        btn.innerText = c.text;
        btn.className = 'btn';
        btn.onclick = ()=> goTo(c.target);
        choicesContainer.appendChild(btn);
      });
      setTimeout(()=> choicesContainer.style.opacity = '1', 100);
    }

    updatePrologue();
  </script>
</body>
</html>
